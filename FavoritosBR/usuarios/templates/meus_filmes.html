{% extends "base.html" %}
{% load static %}

{% block title %}FavoritosBR - Meus Filmes{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'baseFilmes/css/style.css' %}">
{% endblock %}

{% block content %}
<header class="site-header">
    <div class="header-text">
      {% if aba == "favoritos" %}
        <h1>⭐ Favoritos</h1>
      {% else %}
        <h1>✅ Assistidos</h1>
      {% endif %}
    </div>
</header>

<main>
    <div style="margin-bottom: 1em;">
        {% if aba == "favoritos" %}
            <a href="?aba=assistidos" class="botao-roleta">✅ Ver Assistidos</a>
        {% else %}
            <a href="?aba=favoritos" class="botao-roleta">⭐ Ver Favoritos</a>
        {% endif %}
    </div>

    {% if aba == "favoritos" %}
        <div class="filmes-grid">
            {% for filme in favoritos %}
                <div class="filme-card">
                    {% if filme.poster %}
                        <img src="{{ filme.poster }}" alt="Pôster de {{ filme.titulo }}">
                    {% else %}
                        <div class="poster-placeholder">Sem imagem</div>
                    {% endif %}
                    <h3>{{ filme.titulo }}</h3>
                    <p>{{ filme.created_at|date:"d/m/Y" }}</p>
                    <button class="marcar-assistido" data-filme-id="{{ filme.filme_id_api }}">
                        ✅ Marcar como assistido
                    </button>
                </div>
            {% empty %}
                <p>Você ainda não favoritou filmes.</p>
            {% endfor %}
        </div>
    {% else %}
        <div class="filmes-grid">
            {% for filme in assistidos %}
                <div class="filme-card">
                    {% if filme.poster %}
                        <img src="{{ filme.poster }}" alt="Pôster de {{ filme.titulo }}">
                    {% else %}
                        <div class="poster-placeholder">Sem imagem</div>
                    {% endif %}
                    <h3>{{ filme.titulo }}</h3>
                    <p>{{ filme.assistiu_at|date:"d/m/Y" }}</p>
                </div>
            {% empty %}
                <p>Você ainda não marcou filmes como assistidos.</p>
            {% endfor %}
        </div>
    {% endif %}
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".marcar-assistido").forEach(botao => {
        botao.addEventListener("click", () => {
            const filme_id = botao.getAttribute("data-filme-id");

            fetch("{% url 'marcar_como_assistido' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ filme_id_api: parseInt(filme_id) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    location.reload();
                } else {
                    alert("Erro ao marcar como assistido.");
                }
            });
        });
    });
});
</script>
{% endblock %}
